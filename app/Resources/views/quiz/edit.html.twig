{% extends 'base.html.twig' %}

{% block header %}{{ 'quiz.edit'|trans }}{% endblock %}
{% block header_desc %}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jstree/3.0.9/themes/default/style.min.css" />
{% endblock %}

{% block body %}
    <div class="nav-tabs-custom">
        <ul class="nav nav-tabs">
              <li class="active"><a href="#tab-basic" data-toggle="tab" aria-expanded="true">{{ 'basic'|trans }}</a></li>
              <li class=""><a href="#tab-structure" data-toggle="tab" aria-expanded="false">{{ 'structure'|trans }}</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane active" id="tab-basic">
                {{ form_start(edit_form) }}
                    {{ form_widget(edit_form) }}
                    <input type="submit" value="Edit" class="btn btn-primary" />
                {{ form_end(edit_form) }}
            </div>

            <div class="tab-pane" id="tab-structure">
                <div class="chart">
                    <div class="tree"></div>
                    <div class="modal fade" id="modal-question" tabindex="-1" role="dialog" aria-labelledby="modal-question-label">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a class="btn btn-app" href="{{ path('quiz_index') }}">
        <i class="fa fa-arrow-left"></i> {{ 'back_list'|trans }}
    </a>
    {{ form_start(delete_form) }}
        <input type="submit" value="{{ 'delete'|trans }}" class="btn btn-app">
    {{ form_end(delete_form) }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="//cdnjs.cloudflare.com/ajax/libs/jstree/3.0.9/jstree.min.js"></script>
    <script>
        $(function() {
            $('#modal-question').on('hide.bs.modal', function (e) {
                $('.tree').jstree(true).refresh();
            });

            $('.tree').jstree({
                'core' : {
                    'data' : {
                        "url" : "{{ path('quiz_show_tree', {id: quiz.id}) }}",
                    },
                    "check_callback" : true
                },
                "contextmenu":{
                    "items": function($node) {
                        var tree = $(".tree").jstree(true);
                        if ($node.original.type == 'question') {
                            return {
                                "edit": {
                                    "id": $node.original.id,
                                    "label": "Editer la structure de cette question",
                                    "action": editQuestion
                                }
                            };
                        } else if ($node.original.type == 'answer') {
                            return {
                                "add": {
                                    "id": $node.original.id,
                                    "label": "Ajouter une nouvelle question",
                                    "_disabled": $node.children.length > 0,
                                    "action": addQuestion
                                }
                            };
                        }
                    }
                },
                "plugins" : ["dnd", "contextmenu"]
            });
        });

        function editQuestion(obj) {
            var id = obj.item.id.split('-')[1];
            var url = Routing.generate('question_edit', { id: id });
            $('#modal-question').modal('show');
            $.get(url, function (data) {
                $('#modal-question .modal-content').html(data);

                // Ajaxify edit process
                $('input.btn-edit-question').click(function() {
                    var $form = $('form.form-edit-question');
                    $.post(url, $form.serialize(), function() {
                        $('#modal-question').modal('hide');
                    });
                });

                // Ajaxify delete process
                $('input.btn-delete-question').click(function() {
                    var $form = $('form.form-delete-question');
                    $.ajax($form.attr('action'), {
                        method: 'DELETE',
                        data: $form.serialize(),
                        success: function() {
                            $('#modal-question').modal('hide');
                        }
                    });
                });
            });
        }

        function addQuestion(obj) {
            var id = obj.item.id.split('-')[1];
            var url = Routing.generate('question_new', {previousAnswer: id});
            $('#modal-question').modal('show');
            $.get(url, function (data) {
                $('#modal-question .modal-content').html(data);

                // Ajaxify new process
                $('input.btn-new-question').click(function() {
                    var $form = $('form.form-new-question');
                    $.post(url, $form.serialize(), function() {
                        $('#modal-question').modal('hide');
                    });
                });
            });
        }
    </script>
{% endblock %}